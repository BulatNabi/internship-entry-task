# Проект "Крестики-нолики" (TestTaskModulBank)

Этот проект представляет собой Web API для игры в "Крестики-нолики" (Tic-Tac-Toe), разработанный на ASP.NET Core.

## Быстрый старт (с Docker Compose)

Самый простой способ запустить проект — использовать Docker Compose, который автоматически поднимет API и базу данных PostgreSQL.

1.  **Предварительные требования:**
    * [Docker Desktop](https://www.docker.com/products/docker-desktop/) (включает Docker Compose).
    * Git.

2.  **Клонируйте репозиторий:**
    ```bash
    git clone [https://github.com/BulatNabi/internship-entry-task.git](https://github.com/BulatNabi/internship-entry-task.git)
    cd internship-entry-task/TestTaskModulBank
    ```
    (Убедитесь, что вы находитесь в папке `TestTaskModulBank`, где лежат `Dockerfile` и `docker-compose.yml`.)

3.  **Соберите и запустите сервисы:**
    ```bash
    docker-compose up --build -d
    ```
    Это соберет образ API, поднимет контейнеры API и PostgreSQL, а также применит миграции базы данных (если они настроены на автоматическое применение при старте API).

4.  **Доступ к API:**
    Ваш API будет доступен по адресу: `http://localhost/`

5.  **Остановка сервисов:**
    ```bash
    docker-compose down
    ```
    Для удаления данных базы данных (вместе с томами):
    ```bash
    docker-compose down -v
    ```

## Общая суть и архитектурные решения

Проект представляет собой монолитное ASP.NET Core Web API, разработанное с соблюдением принципов чистой архитектуры, несмотря на единую сборку.

### Структура и Слоистая Архитектура
Проект организован в слои через логическое разделение на папки (`Controllers`, `Services`, `Repositories`, `Models`, `DTOs`, `Interfaces`, `Converters`, `Data`).
* **Controllers:** Тонкий слой, отвечающий за обработку HTTP-запросов и делегирование бизнес-логики.
* **Services:** Содержат основную бизнес-логику игры (валидация ходов, проверка победы/ничьей, управление состоянием игры).
* **Repositories:** Абстрагируют доступ к данным, взаимодействуя с базой данных (Entity Framework Core с PostgreSQL).
* **Models/DTOs:** Определяют сущности предметной области и контракты для взаимодействия с API.
* **Interfaces:** Используются для инверсии зависимостей и облегчения тестирования.

### Работа с Игровым Полем
Игровое поле (`PlayerSymbol[,]`) хранится в базе данных в виде сериализованной JSON-строки (`Game.BoardJson`). Это обеспечивает гибкость в размерах поля и оптимизацию хранения. Для автоматической сериализации/десериализации используется кастомный `PlayerSymbolArrayConverter` и `JsonSerializerOptions` (включающие `JsonStringEnumConverter` для корректной работы с Enum).

### Идемпотентность Ходов
Эндпоинт `POST /api/games/{id}/move` спроектирован идемпотентным. Повторный запрос с уже сделанным ходом приведет к возврату текущего состояния игры (200 OK) без повторной обработки, предотвращая нежелательные побочные эффекты.

### Работа с ETag
Эндпоинт `GET /api/games/{id}` поддерживает кэширование с помощью заголовка `ETag`. Это позволяет клиентам эффективно проверять актуальность данных: если игра не изменилась, сервер возвращает `304 Not Modified`, снижая нагрузку и сетевой трафик.

### Обработка Ошибок
API использует стандарт `ProblemDetails` (RFC 7807) для предоставления подробной и единообразной информации об ошибках (например, `400 Bad Request` для невалидных ходов, `404 Not Found` для отсутствующих игр).

### Конфигурация
Условие победы (количество символов для выигрыша) конфигурируется через `IConfiguration`, что позволяет легко менять его значение (по умолчанию 3) через `appsettings.json` или переменные окружения.

## API Эндпоинты

* `POST /api/games`: Создать новую игру (требует `boardSize`).
* `GET /api/games/{id}`: Получить состояние игры по ID.
* `POST /api/games/{id}/move`: Сделать ход в игре по ID.

## Тестирование

Проект включает юнит- и интеграционные тесты (`TestTaskModulBank.Tests`) для обеспечения надежности и корректности работы компонентов и API.

## Устранение частых проблем

* **Проблемы с `Program` accessibility в тестах:** Сделайте `Program` класс публичным и добавьте `<InternalsVisibleTo Include="TestTaskModulBank.Tests" />` в `.csproj` API-проекта.
* **Ошибка `fatal: refusing to merge unrelated histories` (Git):** Используйте `git pull origin main --allow-unrelated-histories` для принудительного слияния несвязанных историй.
* **`MakeMoveDto` не существует:** Используйте правильное имя класса `MakeMoveRequestDto`.

---

**Автор:** Булат Наби - [https://github.com/BulatNabi](https://github.com/BulatNabi)
